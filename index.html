<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Ç–∞–∫—Å–∏ - –∑–≤–æ–Ω–æ–∫</title>
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; background: #1a1a1a; color: white; }
        #status { margin-bottom: 20px; padding: 10px; background: #333; border-radius: 5px; }
        #video-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .participant { background: #2a2a2a; border-radius: 10px; overflow: hidden; width: 45%; min-width: 300px; }
        .participant video { width: 100%; height: auto; display: block; background: #000; }
        .participant .label { padding: 8px; text-align: center; background: #3a3a3a; }
        .controls { margin-top: 20px; text-align: center; }
        button { padding: 12px 24px; margin: 0 10px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; background: #4CAF50; color: white; }
        button.danger { background: #f44336; }
    </style>
</head>
<body>
    <div id="status">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É...</div>
    <div id="video-container" style="display: none;"></div>
    <div class="controls" style="display: none;">
        <button id="mute-btn">üîä –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <button id="video-btn">üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ</button>
        <button id="leave-btn" class="danger">‚ùå –ü–æ–∫–∏–Ω—É—Ç—å –∑–≤–æ–Ω–æ–∫</button>
    </div>

    <script>
        (async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const livekitUrl = urlParams.get('url');
            const roomName = urlParams.get('room');
            const token = urlParams.get('token');

            const statusDiv = document.getElementById('status');
            const videoContainer = document.getElementById('video-container');
            const controlsDiv = document.querySelector('.controls');

            if (!livekitUrl || !roomName || !token) {
                statusDiv.innerText = '‚ùå –û—à–∏–±–∫–∞: –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.';
                return;
            }

            statusDiv.innerText = `üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomName}...`;

            try {
                const room = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                });

                room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
                    console.log('–£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:', participant.identity);
                });

                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    console.log('–ü–æ–ª—É—á–µ–Ω —Ç—Ä–µ–∫:', track.kind, '–æ—Ç', participant.identity);
                    const element = track.attach();
                    const participantDiv = document.getElementById(`p-${participant.identity}`) || document.createElement('div');
                    
                    if (!participantDiv.id) {
                        participantDiv.id = `p-${participant.identity}`;
                        participantDiv.className = 'participant';
                        participantDiv.innerHTML = `<div class="label">${participant.name || participant.identity}</div>`;
                        videoContainer.appendChild(participantDiv);
                    }
                    
                    const videoWrapper = document.createElement('div');
                    videoWrapper.className = 'video-wrapper';
                    videoWrapper.appendChild(element);
                    participantDiv.appendChild(videoWrapper);
                });

                room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
                    console.log('–¢—Ä–µ–∫ –æ—Ç–ø–∏—Å–∞–Ω:', track.kind);
                    track.detach();
                });

                room.on(LivekitClient.RoomEvent.Disconnected, () => {
                    statusDiv.innerText = 'üîå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç –∑–≤–æ–Ω–∫–∞.';
                    videoContainer.innerHTML = '';
                    controlsDiv.style.display = 'none';
                    statusDiv.style.display = 'block';
                });

                await room.connect(livekitUrl, token);

                // –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–≤–æ–∏ –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ
                await room.localParticipant.enableCameraAndMicrophone();
                
                statusDiv.style.display = 'none';
                videoContainer.style.display = 'flex';
                controlsDiv.style.display = 'block';

                // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                let audioEnabled = true;
                let videoEnabled = true;

                document.getElementById('mute-btn').onclick = () => {
                    audioEnabled = !audioEnabled;
                    room.localParticipant.setMicrophoneEnabled(audioEnabled);
                    document.getElementById('mute-btn').innerHTML = audioEnabled ? 'üîä –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω' : 'üîá –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                };

                document.getElementById('video-btn').onclick = () => {
                    videoEnabled = !videoEnabled;
                    room.localParticipant.setCameraEnabled(videoEnabled);
                    document.getElementById('video-btn').innerHTML = videoEnabled ? 'üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ' : 'üìπ –í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ';
                };

                document.getElementById('leave-btn').onclick = () => {
                    room.disconnect();
                    window.close();
                };

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                statusDiv.innerText = `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`;
            }
        })();
    </script>
</body>
</html>
