<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Ç–∞–∫—Å–∏ - –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
        }
        
        #room-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
            text-align: center;
            padding: 20px;
        }
        
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 5px solid white;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #loading-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        #loading-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        #error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 20px;
        }
        
        #error-screen.visible {
            display: flex;
        }
        
        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        #error-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        #error-message {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 30px;
            max-width: 300px;
        }
        
        .retry-btn {
            background: white;
            color: #f5576c;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        
        .retry-btn:hover {
            transform: scale(1.05);
        }
        
        .retry-btn:active {
            transform: scale(0.95);
        }
        
        #controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 100;
            padding: 0 20px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .control-btn span {
            font-size: 10px;
            margin-top: 2px;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .control-btn.end-call {
            background: #dc3545;
            border-color: #ff6b7b;
        }
        
        .control-btn.end-call:hover {
            background: #c82333;
        }
        
        .control-btn.muted {
            background: rgba(220, 53, 69, 0.8);
            border-color: #ff6b7b;
        }
        
        .control-btn.video-off {
            background: rgba(220, 53, 69, 0.8);
            border-color: #ff6b7b;
        }
        
        #status-message {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 14px;
            text-align: center;
            z-index: 200;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        #status-message.visible {
            opacity: 1;
        }
        
        #participant-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 200;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        #video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .participant-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #self-video {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 120px;
            height: 160px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 150;
        }
        
        #self-video:hover {
            transform: scale(1.05);
            border-color: white;
        }
        
        #self-video.minimized {
            width: 80px;
            height: 106px;
        }
        
        #self-video.hidden {
            display: none;
        }
        
        @media (max-width: 600px) {
            #self-video {
                width: 100px;
                height: 133px;
                bottom: 90px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            #loading-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="room-container">
        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-screen">
            <div class="loader"></div>
            <div id="loading-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É...</div>
            <div id="loading-subtitle">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
            <div style="font-size: 12px; opacity: 0.7;">–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Ç–∞–∫—Å–∏</div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ -->
        <div id="error-screen">
            <div class="error-icon">üòï</div>
            <div id="error-title">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
            <div id="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∑–≤–æ–Ω–∫—É</div>
            <button class="retry-btn" onclick="location.reload()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ -->
        <div id="video-container">
            <video id="remote-video" class="participant-video" autoplay playsinline></video>
            <video id="self-video" autoplay playsinline muted></video>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö -->
        <div id="participant-info">
            <span id="participant-count">1</span> —É—á–∞—Å—Ç–Ω–∏–∫
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ -->
        <div id="status-message"></div>
        
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="controls">
            <div class="control-btn" id="mute-btn" onclick="toggleMute()">
                üé§
                <span>–ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>
            </div>
            <div class="control-btn" id="video-btn" onclick="toggleVideo()">
                üìπ
                <span>–í–∏–¥–µ–æ</span>
            </div>
            <div class="control-btn end-call" id="end-call-btn" onclick="endCall()">
                ‚ùå
                <span>–í—ã–π—Ç–∏</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@livekit/components-styling@1.0.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@1.15.0/dist/livekit-client.umd.min.js"></script>
    
    <script>
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const livekitUrl = urlParams.get('url');
        const roomName = urlParams.get('room');
        const token = urlParams.get('token');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let room;
        let localTrack;
        let localVideoTrack;
        let localAudioTrack;
        let isMuted = false;
        let isVideoEnabled = true;
        let participants = new Map();
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const loadingScreen = document.getElementById('loading-screen');
        const errorScreen = document.getElementById('error-screen');
        const errorMessage = document.getElementById('error-message');
        const remoteVideo = document.getElementById('remote-video');
        const selfVideo = document.getElementById('self-video');
        const muteBtn = document.getElementById('mute-btn');
        const videoBtn = document.getElementById('video-btn');
        const participantCount = document.getElementById('participant-count');
        const statusMessage = document.getElementById('status-message');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
        function showStatus(msg, duration = 3000) {
            statusMessage.textContent = msg;
            statusMessage.classList.add('visible');
            setTimeout(() => {
                statusMessage.classList.remove('visible');
            }, duration);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        if (!livekitUrl || !roomName || !token) {
            errorMessage.textContent = '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            loadingScreen.classList.add('hidden');
            errorScreen.classList.add('visible');
        } else {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            initializeCall();
        }
        
        async function initializeCall() {
            try {
                showStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');
                
                // –°–æ–∑–¥–∞—ë–º –∫–æ–º–Ω–∞—Ç—É
                room = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                    videoCaptureDefaults: {
                        resolution: LivekitClient.VideoPresets.h720.resolution,
                    },
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                room.on(LivekitClient.RoomEvent.TrackSubscribed, handleTrackSubscribed);
                room.on(LivekitClient.RoomEvent.TrackUnsubscribed, handleTrackUnsubscribed);
                room.on(LivekitClient.RoomEvent.ParticipantConnected, handleParticipantConnected);
                room.on(LivekitClient.RoomEvent.ParticipantDisconnected, handleParticipantDisconnected);
                room.on(LivekitClient.RoomEvent.Disconnected, handleDisconnected);
                room.on(LivekitClient.RoomEvent.ConnectionQualityChanged, handleConnectionQuality);
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞
                try {
                    localAudioTrack = await LivekitClient.createLocalAudioTrack();
                    localVideoTrack = await LivekitClient.createLocalVideoTrack({
                        resolution: LivekitClient.VideoPresets.h720.resolution,
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—ë –≤–∏–¥–µ–æ
                    localVideoTrack.attach(selfVideo);
                    
                } catch (mediaError) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞:', mediaError);
                    showStatus('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 5000);
                }
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                await room.connect(livekitUrl, token);
                
                // –ü—É–±–ª–∏–∫—É–µ–º —Ç—Ä–µ–∫–∏
                if (localAudioTrack) {
                    await room.localParticipant.publishTrack(localAudioTrack);
                }
                if (localVideoTrack) {
                    await room.localParticipant.publishTrack(localVideoTrack);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                loadingScreen.classList.add('hidden');
                updateParticipantCount();
                showStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∑–≤–æ–Ω–∫—É', 2000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                errorMessage.textContent = error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∑–≤–æ–Ω–∫—É';
                loadingScreen.classList.add('hidden');
                errorScreen.classList.add('visible');
            }
        }
        
        function handleTrackSubscribed(track, publication, participant) {
            console.log('–ü–æ–ª—É—á–µ–Ω —Ç—Ä–µ–∫ –æ—Ç:', participant.identity);
            
            if (track.kind === 'video') {
                track.attach(remoteVideo);
            } else if (track.kind === 'audio') {
                track.attach(new Audio());
            }
            
            updateParticipantCount();
        }
        
        function handleTrackUnsubscribed(track, publication, participant) {
            console.log('–¢—Ä–µ–∫ –æ—Ç–ø–∏—Å–∞–Ω:', participant.identity);
            track.detach();
            updateParticipantCount();
        }
        
        function handleParticipantConnected(participant) {
            console.log('–£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:', participant.identity);
            participants.set(participant.identity, participant);
            updateParticipantCount();
            showStatus(`üë§ ${participant.name || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, 3000);
        }
        
        function handleParticipantDisconnected(participant) {
            console.log('–£—á–∞—Å—Ç–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è:', participant.identity);
            participants.delete(participant.identity);
            updateParticipantCount();
            showStatus(`üëã ${participant.name || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'} –ø–æ–∫–∏–Ω—É–ª –∑–≤–æ–Ω–æ–∫`, 3000);
        }
        
        function handleDisconnected() {
            console.log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç –∫–æ–º–Ω–∞—Ç—ã');
            showStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç –∑–≤–æ–Ω–∫–∞', 3000);
            setTimeout(() => {
                window.close();
            }, 3000);
        }
        
        function handleConnectionQuality(quality) {
            console.log('–ö–∞—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', quality);
        }
        
        function updateParticipantCount() {
            if (!room) return;
            const count = room.participants.size + 1; // +1 –∑–∞ —Å–µ–±—è
            participantCount.textContent = count;
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º
        async function toggleMute() {
            if (!localAudioTrack) return;
            
            try {
                if (isMuted) {
                    await localAudioTrack.unmute();
                    muteBtn.innerHTML = 'üé§<span>–ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>';
                    muteBtn.classList.remove('muted');
                    showStatus('üîä –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω');
                } else {
                    await localAudioTrack.mute();
                    muteBtn.innerHTML = 'üîá<span>–ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>';
                    muteBtn.classList.add('muted');
                    showStatus('üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á—ë–Ω');
                }
                isMuted = !isMuted;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            }
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ
        async function toggleVideo() {
            if (!localVideoTrack) return;
            
            try {
                if (isVideoEnabled) {
                    await localVideoTrack.mute();
                    selfVideo.classList.add('hidden');
                    videoBtn.innerHTML = 'üìπ<span>–í–∏–¥–µ–æ</span>';
                    videoBtn.classList.add('video-off');
                    showStatus('üìπ –í–∏–¥–µ–æ –≤—ã–∫–ª—é—á–µ–Ω–æ');
                } else {
                    await localVideoTrack.unmute();
                    selfVideo.classList.remove('hidden');
                    videoBtn.innerHTML = 'üìπ<span>–í–∏–¥–µ–æ</span>';
                    videoBtn.classList.remove('video-off');
                    showStatus('üìπ –í–∏–¥–µ–æ –≤–∫–ª—é—á–µ–Ω–æ');
                }
                isVideoEnabled = !isVideoEnabled;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
            }
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        async function endCall() {
            if (room) {
                showStatus('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞...');
                await room.disconnect();
                setTimeout(() => {
                    window.close();
                }, 1000);
            } else {
                window.close();
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å–≤–æ–µ–≥–æ –≤–∏–¥–µ–æ
        selfVideo.addEventListener('click', () => {
            selfVideo.classList.toggle('minimized');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (room) {
                room.disconnect();
            }
        });
    </script>
</body>
</html>