<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Ç–∞–∫—Å–∏ - –∑–≤–æ–Ω–æ–∫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .status {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 16px;
        }

        .video-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .participant {
            background: #1e1e1e;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            position: relative;
        }

        .participant video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #2a2a2a;
        }

        .label {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: rgba(0,0,0,0.6);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(4px);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 20px 0;
            flex-wrap: wrap;
        }

        button {
            min-width: 120px;
            padding: 14px 24px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #2e2e2e;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        button.primary {
            background: #4CAF50;
        }

        button.danger {
            background: #f44336;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #ff6b6b;
            background: #2a1a1a;
            border: 1px solid #ff4444;
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        #permission-prompt {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        #permission-prompt button {
            background: #4CAF50;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="status" id="status">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É...</div>

    <div id="permission-prompt" class="hidden">
        <div style="font-size: 48px; margin-bottom: 16px;">üé§</div>
        <div style="font-size: 18px; margin-bottom: 12px;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</div>
        <div style="color: #aaa; margin-bottom: 20px;">–ß—Ç–æ–±—ã –æ–±—â–∞—Ç—å—Å—è —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º</div>
        <button onclick="requestPermissions()">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
    </div>

    <div class="video-container hidden" id="video-container">
        <div class="participant" id="local-participant">
            <div class="label" id="local-label">–í—ã</div>
        </div>
        <div class="participant hidden" id="remote-participant">
            <div class="label" id="remote-label">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
        </div>
    </div>

    <div class="controls hidden" id="controls">
        <button id="mic-btn" class="primary">üé§ –í—ã–∫–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <button id="leave-btn" class="danger">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <div id="error-message" class="hidden"></div>

    <script>
        (async function() {
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            const livekitUrl = urlParams.get('url');
            const roomName = urlParams.get('room');
            const token = urlParams.get('token');

            const statusDiv = document.getElementById('status');
            const videoContainer = document.getElementById('video-container');
            const controlsDiv = document.getElementById('controls');
            const errorDiv = document.getElementById('error-message');
            const permissionPrompt = document.getElementById('permission-prompt');

            const localVideo = document.createElement('video');
            localVideo.autoplay = true;
            localVideo.playsInline = true;
            localVideo.muted = true;
            document.getElementById('local-participant').appendChild(localVideo);

            const remoteVideo = document.createElement('video');
            remoteVideo.autoplay = true;
            remoteVideo.playsInline = true;
            document.getElementById('remote-participant').appendChild(remoteVideo);

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
            function showError(text) {
                console.error('‚ùå', text);
                statusDiv.innerText = '‚ùå ' + text;
                errorDiv.innerText = text;
                errorDiv.classList.remove('hidden');
                permissionPrompt.classList.add('hidden');
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            if (!livekitUrl || !roomName || !token) {
                showError('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                return;
            }

            statusDiv.innerText = `üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomName}...`;

            try {
                // –°–æ–∑–¥–∞—ë–º –∫–æ–º–Ω–∞—Ç—É LiveKit —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                const room = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                    videoCaptureDefaults: {
                        resolution: LivekitClient.VideoPresets.h540.resolution,
                    },
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                room.on(LivekitClient.RoomEvent.MediaDevicesError, (error) => {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:', error);
                    if (error.message.includes('Permission')) {
                        permissionPrompt.classList.remove('hidden');
                        statusDiv.classList.add('hidden');
                    }
                });

                room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω —Ç—Ä–µ–∫ –æ—Ç', participant.identity);
                    if (participant.identity === 'ai_bot') {
                        document.getElementById('remote-participant').classList.remove('hidden');
                        document.getElementById('remote-label').innerText = participant.name || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
                        track.attach(remoteVideo);
                    }
                });

                room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
                    console.log('üë§ –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:', participant.identity);
                });

                room.on(LivekitClient.RoomEvent.Disconnected, () => {
                    console.log('üîå –û—Ç–∫–ª—é—á–µ–Ω–æ');
                    statusDiv.innerText = 'üîå –û—Ç–∫–ª—é—á–µ–Ω–æ';
                    statusDiv.classList.remove('hidden');
                    videoContainer.classList.add('hidden');
                    controlsDiv.classList.add('hidden');
                });

                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
                await room.connect(livekitUrl, token);
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ');

                // –ü—ã—Ç–∞–µ–º—Å—è –≤–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω (–Ω–æ –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è)
                try {
                    await room.localParticipant.enableMicrophone();
                    console.log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω');
                } catch (micError) {
                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω:', micError);
                    permissionPrompt.classList.remove('hidden');
                    statusDiv.classList.add('hidden');
                    return;
                }

                // –í–∫–ª—é—á–∞–µ–º –≤–∏–¥–µ–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                try {
                    await room.localParticipant.enableCamera();
                    console.log('‚úÖ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞');
                } catch (camError) {
                    console.warn('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞:', camError);
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—ë –≤–∏–¥–µ–æ
                if (room.localParticipant.videoTracks.size > 0) {
                    const track = room.localParticipant.videoTracks.values().next().value?.track;
                    if (track) {
                        track.attach(localVideo);
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                statusDiv.classList.add('hidden');
                videoContainer.classList.remove('hidden');
                controlsDiv.classList.remove('hidden');
                permissionPrompt.classList.add('hidden');

                // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                let micEnabled = true;
                let camEnabled = true;

                document.getElementById('mic-btn').onclick = () => {
                    micEnabled = !micEnabled;
                    room.localParticipant.setMicrophoneEnabled(micEnabled);
                    document.getElementById('mic-btn').innerHTML = micEnabled ? 'üé§ –í—ã–∫–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω' : 'üîá –í–∫–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω';
                };

                document.getElementById('leave-btn').onclick = () => {
                    room.disconnect();
                    window.close();
                };

            } catch (error) {
                showError(error.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        })();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        window.requestPermissions = async function() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                location.reload();
            } catch (e) {
                alert('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.');
            }
        };
    </script>
</body>
</html>
